---
layout: post
title: "Cold Flow와 Upstream 재수집 문제 해결"
date: 2025-09-04 10:00:00 +0900
categories: [개발]
tags: [TIL, Kotlin, Refactor]
excerpt: "asFlow는 콜드 스트림을 만들어 호출할 때마다 재실행될 수 있음에 유의해야 한다."
published: true
---

### 문제점

```kotlin
val a = fooRepository.findAll().asFlow()

val result = barRepository.findAll()
    .mapNotNull { b ->
        barStatus = a.firstOrNull { it.id = b.fooId }.status
    }
```

위와 같은 상황에서, asFlow 는 콜드 플로우 (수집 때마다 실행) 를 만든다.
그래서 firstOrNull을 호출할 때마다 업스트림 (현재 단계 이전 연산) 을 처음부터 다시 수집한다.
매번 전체를 호출하는 비용이 발생하므로 N+1 쿼리와 유사한 문제가 된다.
그리고 계속 리스트 안에서 값을 비교해가며 맞는 요소를 찾고 있다.

### 개선안

```kotlin
val a = fooRepository
            .findAll()
            .collectList()
            .awaitSingle()
            .associate { it.id to it.status }

val result = barRepository.findAll()
    .mapNotNull { b ->
        barStatus = a[b.fooId]
    }
```

전체를 읽어오는 과정은 필요하므로 한 번만 읽어올 수 있도록 한다.
그리고 Map 으로 인덱싱하여 O(1)의 조회를 할 수 있도록 한다.

cf. 핫 플로우로 바꿔버릴 수도 있지만, 복잡도는 이 편이 낫다.